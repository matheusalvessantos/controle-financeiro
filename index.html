<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro Profissional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Adicionado Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Script para evitar "flash" do modo escuro. Tem que estar no <head>.
        // Esta lógica LÊ a preferência do sistema.
        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .sidebar-button.active {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        #add-modal, #loading-overlay {
            display: none;
        }
        /* Estilo para a tabela com rolagem */
        .table-wrapper {
            max-height: 60vh;
            overflow-y: auto;
        }
        /* Botões de Ação */
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 9999px; /* rounded-full */
            transition: background-color 0.2s;
        }
        .action-btn:hover {
            background-color: #e5e7eb; /* gray-200 */
        }
        .dark .action-btn:hover {
            background-color: #374151; /* gray-700 */
        }
        
        /* Esconder campos do formulário por padrão */
        #tipo-despesa-row, #tipo-valor-row {
            display: none;
        }
        /* Estilo da barra de progresso do orçamento */
        .progress-bar-bg {
            background-color: #e5e7eb; /* gray-200 */
        }
        .dark .progress-bar-bg {
            background-color: #374151; /* gray-700 */
        }
    </style>
</head>
<!-- CORREÇÃO v6.2: Alterado dark:bg-black para dark:bg-gray-900 (como na foto) -->
<body class="bg-gray-50 dark:bg-gray-900 text-slate-800 dark:text-slate-200 transition-colors duration-200">

    <!-- Overlay de Carregamento -->
    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: flex;">
        <div id="loading-text" class="text-white text-lg font-medium">Carregando dados...</div>
    </div>

    <div class="flex flex-col md:flex-row h-screen">
        
        <!-- Sidebar (Navegação Principal) -->
        <nav class="bg-gray-900 text-slate-300 w-full md:w-64 p-4 space-y-2 flex-shrink-0 flex flex-col">
            <div>
                <h1 class="text-2xl font-bold text-white mb-6 px-2">Matheus & Ana</h1>
                
                <button onclick="showPage('page-dashboard')" class="sidebar-button active w-full flex items-center space-x-3 px-3 py-2 rounded-md font-medium text-sm hover:bg-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    <span>Dashboard</span>
                </button>

                <button onclick="showPage('page-lancamentos')" class="sidebar-button w-full flex items-center space-x-3 px-3 py-2 rounded-md font-medium text-sm hover:bg-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                    <span>Lançamentos</span>
                </button>
                
                <!-- Novo Botão: Orçamentos -->
                <button onclick="showPage('page-orcamento')" class="sidebar-button w-full flex items-center space-x-3 px-3 py-2 rounded-md font-medium text-sm hover:bg-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20v-6M12 14v-4M12 10V4M4 20v-2M4 18v-4M4 14V4M20 20v-4M20 16v-4M20 12V4M16 20v-2M16 18v-4M16 14V4M8 20v-4M8 16v-4M8 12V4"></path></svg>
                    <span>Orçamentos</span>
                </button>

                <button onclick="showPage('page-config')" class="sidebar-button w-full flex items-center space-x-3 px-3 py-2 rounded-md font-medium text-sm hover:bg-gray-700 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.1a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1 0-2l.15-.1a2 2 0 0 0 .73 2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                    <span>Configurações</span>
                </button>
            </div>
            
            <!-- User ID Display -->
            <div class="mt-auto pt-4 border-t border-gray-700">
                 <span class="text-xs text-slate-500 px-2">ID de Usuário:</span>
                 <span id="userIdDisplay" class="text-xs text-slate-400 px-2 break-all">Carregando...</span>
            </div>
        </nav>

        <!-- Conteúdo Principal -->
        <main class="flex-1 overflow-y-auto p-6 md:p-10">

            <!-- Página 1: Dashboard -->
            <div id="page-dashboard" class="page-content space-y-8">
                <header class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900 dark:text-slate-100">Dashboard</h2>
                        <p class="text-slate-600 dark:text-slate-400">Seu resumo financeiro.</p>
                    </div>
                     <!-- Filtros de Mês/Ano -->
                    <div class="flex gap-4 mt-4 md:mt-0">
                        <div>
                            <label for="filter-month" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Mês</label>
                            <select id="filter-month" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm transition-colors duration-200">
                                <!-- Preenchido por JS -->
                            </select>
                        </div>
                        <div>
                            <label for="filter-year" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Ano</label>
                            <select id="filter-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm transition-colors duration-200">
                                <!-- Preenchido por JS -->
                            </select>
                        </div>
                    </div>
                </header>

                <!-- Cards de Resumo -->
                <!-- CORREÇÃO v6.2: Alterado dark:bg-gray-900 para dark:bg-gray-800 (como na foto) -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-slate-200 dark:border-gray-700 transition-colors duration-200">
                        <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Receitas</h3>
                        <p id="dash-receitas" class="mt-2 text-3xl font-semibold text-green-600">R$ 0,00</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-slate-200 dark:border-gray-700 transition-colors duration-200">
                        <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Despesas Pagas</h3>
                        <p id="dash-despesas" class="mt-2 text-3xl font-semibold text-red-600">R$ 0,00</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-slate-200 dark:border-gray-700 transition-colors duration-200">
                        <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Saldo do Mês</h3>
                        <p id="dash-saldo" class="mt-2 text-3xl font-semibold text-indigo-500">R$ 0,00</p>
                    </div>
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-orange-300 dark:border-orange-700 transition-colors duration-200">
                        <h3 class="text-sm font-medium text-slate-500 dark:text-slate-400">Pendentes</h3>
                        <p id="dash-pendentes" class="mt-2 text-3xl font-semibold text-orange-500">R$ 0,00</p>
                    </div>
                </div>

                <!-- Gráficos e Tabelas -->
                <!-- CORREÇÃO v6.2: Alterado dark:bg-gray-900 para dark:bg-gray-800 (como na foto) -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Gastos por Categoria (Gráfico) -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-slate-200 dark:border-gray-700 transition-colors duration-200">
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-4">Gastos por Categoria (Pagos)</h3>
                        <!-- Container do Gráfico -->
                        <div id="dash-categorias" class="relative h-64 md:h-80">
                            <!-- O Canvas ou o texto de "Nenhuma despesa" será injetado aqui pelo JS -->
                        </div>
                    </div>
                    <!-- Faturas de Cartão -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-slate-200 dark:border-gray-700 transition-colors duration-200">
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-4">Contas a Pagar (Pendentes)</h3>
                        <div class="flow-root max-h-80 overflow-y-auto">
                            <ul id="dash-faturas" role="list" class="divide-y divide-slate-200 dark:divide-gray-700">
                                <li class="py-3 text-slate-500 dark:text-slate-400">Nenhuma conta pendente este mês.</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Novo Card: Orçamentos do Mês -->
                <!-- CORREÇÃO v6.2: Alterado dark:bg-gray-900 para dark:bg-gray-800 (como na foto) -->
                <div class="grid grid-cols-1 gap-6">
                     <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-slate-200 dark:border-gray-700 transition-colors duration-200">
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-4">Orçamentos do Mês</h3>
                        <div id="dash-budgets" class="space-y-4 max-h-80 overflow-y-auto">
                            <!-- Progresso do Orçamento injetado aqui -->
                            <p class="text-slate-500 dark:text-slate-400">Nenhum orçamento definido para este mês. Defina na página 'Orçamentos'.</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Página 2: Lançamentos -->
            <div id="page-lancamentos" class="page-content hidden space-y-6">
                <header class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900 dark:text-slate-100">Meus Lançamentos</h2>
                        <p class="text-slate-600 dark:text-slate-400">O banco de dados central de todas as suas movimentações.</p>
                    </div>
                    <!-- Filtros de Mês/Ano para Lançamentos -->
                    <div class="flex gap-4 mt-4 md:mt-0">
                        <div>
                            <label for="tx-filter-month" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Mês</label>
                            <select id="tx-filter-month" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm transition-colors duration-200">
                                <!-- Preenchido por JS -->
                            </select>
                        </div>
                        <div>
                            <label for="tx-filter-year" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Ano</label>
                            <select id="tx-filter-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm transition-colors duration-200">
                                <!-- Preenchido por JS -->
                            </select>
                        </div>
                        <button onclick="openModal('add-modal')" class="mt-4 md:mt-0 self-end bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white font-medium px-4 py-2 rounded-lg shadow-md transition-all duration-200 flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                            <span>Adicionar</span>
                        </button>
                    </div>
                </header>

                <!-- Tabela de Lançamentos -->
                <!-- CORREÇÃO v6.2: Alterado dark:bg-gray-900 para dark:bg-gray-800 (como na foto) -->
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md border border-slate-200 dark:border-gray-700 overflow-hidden transition-colors duration-200">
                    <div class="table-wrapper overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200 dark:divide-gray-700">
                            <thead class="bg-slate-50 dark:bg-gray-700 transition-colors duration-200"> <!-- THead um pouco mais escuro q o card -->
                                <tr>
                                    <th class="p-4 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Descrição</th>
                                    <th class="p-4 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Data Venc.</th>
                                    <th class="p-4 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Data Pagto.</th>
                                    <th class="p-4 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Categoria</th>
                                    <th class="p-4 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Conta</th>
                                    <th class="p-4 text-left text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Tipo</th>
                                    <th class="p-4 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Status</th>
                                    <th class="p-4 text-right text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Valor</th>
                                    <th class="p-4 text-center text-xs font-medium text-slate-500 dark:text-slate-400 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="transactions-table-body" class="bg-white dark:bg-gray-800 divide-y divide-slate-200 dark:divide-gray-700 transition-colors duration-200">
                                <!-- Linhas preenchidas por JS com base no filtro -->
                                <tr><td colspan="9" class="p-4 text-center text-slate-500 dark:text-slate-400">Carregando lançamentos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Nova Página: Orçamentos -->
            <div id="page-orcamento" class="page-content hidden space-y-6">
                <header class="flex flex-col md:flex-row md:items-center md:justify-between">
                    <div>
                        <h2 class="text-3xl font-bold text-slate-900 dark:text-slate-100">Orçamentos Mensais</h2>
                        <p class="text-slate-600 dark:text-slate-400">Defina suas metas de gastos para cada categoria.</p>
                    </div>
                    <!-- Filtros de Mês/Ano para Orçamentos -->
                    <div class="flex gap-4 mt-4 md:mt-0">
                        <div>
                            <label for="budget-filter-month" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Mês</label>
                            <select id="budget-filter-month" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm transition-colors duration-200">
                                <!-- Preenchido por JS -->
                            </select>
                        </div>
                        <div>
                            <label for="budget-filter-year" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Ano</label>
                            <select id="budget-filter-year" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm transition-colors duration-200">
                                <!-- Preenchido por JS -->
                            </select>
                        </div>
                    </div>
                </header>
                
                <!-- Lista de Orçamentos -->
                 <!-- CORREÇÃO v6.2: Alterado dark:bg-gray-900 para dark:bg-gray-800 (como na foto) -->
                 <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-slate-200 dark:border-gray-700 transition-colors duration-200">
                    <div id="budgets-list" class="space-y-4">
                        <p class="text-slate-500 dark:text-slate-400">Carregando categorias...</p>
                        <!-- Inputs de orçamento serão injetados aqui -->
                    </div>
                </div>
            </div>

            <!-- Página 4: Configurações -->
            <div id="page-config" class="page-content hidden space-y-6">
                <header>
                    <h2 class="text-3xl font-bold text-slate-900 dark:text-slate-100">Configurações</h2>
                    <p class="text-slate-600 dark:text-slate-400">Listas mestras para organizar seus lançamentos.</p>
                </header>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Lista de Contas -->
                    <!-- CORREÇÃO v6.2: Alterado dark:bg-gray-900 para dark:bg-gray-800 (como na foto) -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-slate-200 dark:border-gray-700 transition-colors duration-200">
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-4">Minhas Contas e Cartões</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Adicione aqui todas as contas correntes, cartões de crédito e carteiras.</p>
                        <form id="form-add-account" class="flex gap-2 mb-4">
                            <input type="text" id="input-account-name" placeholder="Nome da nova conta" class="flex-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:placeholder-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200" required>
                            <button type="submit" class="bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white px-3 py-2 rounded-lg shadow-md text-sm font-medium transition-all duration-200">Adicionar</button>
                        </form>
                        <ul id="accounts-list" class="divide-y divide-slate-200 dark:divide-gray-700">
                           <!-- Preenchido por JS -->
                           <li class="py-2 text-slate-500 dark:text-slate-400">Nenhuma conta cadastrada.</li>
                        </ul>
                    </div>

                    <!-- Lista de Categorias -->
                    <!-- CORREÇÃO v6.2: Alterado dark:bg-gray-900 para dark:bg-gray-800 (como na foto) -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md border border-slate-200 dark:border-gray-700 transition-colors duration-200">
                        <h3 class="text-lg font-semibold text-slate-800 dark:text-slate-100 mb-4">Minhas Categorias</h3>
                        <p class="text-sm text-slate-500 dark:text-slate-400 mb-4">Crie categorias para agrupar seus gastos (ex: Moradia, Alimentação).</p>
                         <form id="form-add-category" class="flex gap-2 mb-4">
                            <input type="text" id="input-category-name" placeholder="Nome da nova categoria" class="flex-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:placeholder-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200" required>
                            <button type="submit" class="bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white px-3 py-2 rounded-lg shadow-md text-sm font-medium transition-all duration-200">Adicionar</button>
                        </form>
                        <ul id="categories-list" class="divide-y divide-slate-200 dark:divide-gray-700">
                           <!-- Preenchido por JS -->
                           <li class="py-2 text-slate-500 dark:text-slate-400">Nenhuma categoria cadastrada.</li>
                        </ul>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- Modal para Adicionar Lançamento -->
    <div id="add-modal" class="fixed inset-0 bg-black bg-opacity-50 dark:bg-opacity-70 backdrop-blur-sm flex items-center justify-center p-4 z-40 transition-opacity duration-300">
        <!-- CORREÇÃO v6.2: Alterado dark:bg-gray-900 para dark:bg-gray-800 (como na foto) -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl w-full max-w-lg transition-all duration-300">
            <form id="form-add-transaction">
                <!-- Modal Header -->
                <div class="flex justify-between items-center p-5 border-b border-slate-200 dark:border-gray-700">
                    <h3 class="text-xl font-semibold text-slate-800 dark:text-slate-100">Novo Lançamento</h3>
                    <button type="button" onclick="closeModal('add-modal')" class="text-slate-400 hover:text-slate-600 dark:hover:text-slate-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
                <!-- Modal Body -->
                <div class="p-6 space-y-4 max-h-[70vh] overflow-y-auto">
                    <div>
                        <label for="desc" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Descrição</label>
                        <input type="text" id="desc" name="desc" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:placeholder-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200" placeholder="Ex: Supermercado do mês" required>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="tipo" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tipo (Receita/Despesa)</label>
                            <select id="tipo" name="tipo" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200" required>
                                <option value="despesa">Despesa</option>
                                <option value="receita">Receita</option>
                            </select>
                        </div>
                         <!-- Campo Tipo de Despesa -->
                         <div id="tipo-despesa-row">
                            <label for="tipoDespesa" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tipo de Despesa</label>
                            <select id="tipoDespesa" name="tipoDespesa" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200" required>
                                <option value="Variavel">Variável</option>
                                <option value="Fixa">Fixa</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                         <div>
                            <label for="valor" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Valor</label>
                            <input type="number" id="valor" name="valor" step="0.01" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:placeholder-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200" placeholder="0,00" required>
                        </div>
                         <!-- Campo Tipo de Valor (Variável/Parcelas) -->
                        <div id="tipo-valor-row">
                            <label for="tipoValor" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Tipo de Valor</label>
                            <select id="tipoValor" name="tipoValor" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200" required>
                                <option value="parcela">Valor da Parcela</option>
                                <option value="total">Valor Total</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="venc" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Data Vencimento</label>
                            <input type="date" id="venc" name="venc" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:placeholder-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200" required>
                        </div>
                        <div>
                            <label for="pagto" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Data Pagamento (se houver)</label>
                            <input type="date" id="pagto" name="pagto" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:placeholder-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="categoria" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Categoria</label>
                            <select id="categoria" name="categoria" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200" required>
                                <!-- Preenchido por JS -->
                            </select>
                        </div>
                        <div>
                            <label for="conta" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Conta/Cartão</label>
                            <select id="conta" name="conta" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200" required>
                                 <!-- Preenchido por JS -->
                            </select>
                        </div>
                    </div>

                     <div>
                        <!-- Label dinâmico -->
                        <label id="parcelas-label" for="parcelas" class="block text-sm font-medium text-slate-700 dark:text-slate-300">Nº de Parcelas (1 = à vista)</label>
                        <input type="number" id="parcelas" name="parcelas" class="mt-1 block w-full px-3 py-2 border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:placeholder-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200" value="1" min="1" placeholder="1" required>
                    </div>
                </div>
                <!-- Modal Footer -->
                <!-- CORREÇÃO v6.2: Alterado dark:bg-gray-800 para dark:bg-gray-700 (mais escuro) -->
                <div class="flex justify-end items-center p-5 bg-slate-50 dark:bg-gray-700 border-t border-slate-200 dark:border-gray-600 rounded-b-lg transition-colors duration-200">
                    <button type="button" onclick="closeModal('add-modal')" class="text-sm font-medium text-slate-600 dark:text-slate-400 px-4 py-2 rounded-lg hover:bg-slate-200 dark:hover:bg-gray-600 transition-colors duration-200">
                        Cancelar
                    </button>
                    <button type="submit" class="ml-3 text-sm font-medium text-white bg-gradient-to-r from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 px-4 py-2 rounded-lg shadow-md transition-all duration-200">
                        Salvar Lançamento
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Módulos Firebase -->
    <script type="module">
        // Importações do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            addDoc, 
            deleteDoc,
            updateDoc,
            collection, 
            onSnapshot,
            setLogLevel,
            setDoc, // Importar setDoc para orçamentos
            getDoc // Importar getDoc para orçamentos
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- VARIÁVEIS GLOBAIS ---
        let db, auth, currentUserId;
        let allTransactions = []; // Cache local de todas as transações
        let allCategories = [];
        let allAccounts = [];
        let categoryChartInstance = null; // Instância do Gráfico

        // Paleta de cores agradável para o gráfico
        const CHART_COLORS = [
            '#4f46e5', // Indigo
            '#ec4899', // Pink
            '#10b981', // Emerald
            '#f59e0b', // Amber
            '#3b82f6', // Blue
            '#8b5cf6', // Violet
            '#d946ef', // Fuchsia
            '#06b6d4', // Cyan
            '#ef4444', // Red
            '#22c55e'  // Green
        ];

        // Caminhos das coleções
        const transactionsCollectionPath = `transactions`;
        const accountsCollectionPath = `accounts`;
        const categoriesCollectionPath = `categories`;
        const budgetsCollectionPath = `budgets`; // Nova coleção

        // Elementos da UI
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const userIdDisplay = document.getElementById('userIdDisplay');
        
        // Filtros do Dashboard
        const filterMonth = document.getElementById('filter-month');
        const filterYear = document.getElementById('filter-year');
        
        // Filtros da Tabela de Lançamentos
        const txFilterMonth = document.getElementById('tx-filter-month');
        const txFilterYear = document.getElementById('tx-filter-year');
        
        // Filtros da Página de Orçamentos
        const budgetFilterMonth = document.getElementById('budget-filter-month');
        const budgetFilterYear = document.getElementById('budget-filter-year');
        const budgetsListEl = document.getElementById('budgets-list');
        
        const transactionsTableBody = document.getElementById('transactions-table-body');
        const accountsList = document.getElementById('accounts-list');
        const categoriesList = document.getElementById('categories-list');
        
        // Elementos do Modal
        const modalForm = document.getElementById('form-add-transaction');
        const tipoSelect = document.getElementById('tipo');
        const tipoDespesaRow = document.getElementById('tipo-despesa-row');
        const tipoDespesaSelect = document.getElementById('tipoDespesa');
        const tipoValorRow = document.getElementById('tipo-valor-row');
        const parcelasLabel = document.getElementById('parcelas-label');
        const parcelasInput = document.getElementById('parcelas');
        
        const formAddAccount = document.getElementById('form-add-account');
        const formAddCategory = document.getElementById('form-add-category');
        
        const selectCategoria = document.getElementById('categoria');
        const selectConta = document.getElementById('conta');

        // --- INICIALIZAÇÃO ---

        function initFirebase() {
            try {
                // Configuração do Firebase
                const firebaseConfig = {
                  apiKey: "AIzaSyBvtLDBIhCX-x5U-4UnWGEZqM7XO8yQ68g",
                  authDomain: "meu-controle-financeiro-e80f6.firebaseapp.com",
                  projectId: "meu-controle-financeiro-e80f6",
                  storageBucket: "meu-controle-financeiro-e80f6.firebasestorage.app",
                  messagingSenderId: "59168219749",
                  appId: "1:59168219749:web:0c5f36bd8ad54a048a9c8c"
                };
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug'); 

                handleAuthentication();

            } catch (error)
{                console.error("Erro ao inicializar Firebase:", error);
                loadingText.innerText = "Erro ao carregar a aplicação.";
            }
        }
        
        async function handleAuthentication() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUserId = user.uid;
                    userIdDisplay.textContent = currentUserId; 
                    await loadInitialData();
                    loadingOverlay.style.display = 'none';

                } else {
                    console.log("Nenhum usuário logado, tentando autenticação anônima...");
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Erro ao autenticar anonimamente:", error);
                        loadingText.innerText = "Erro ao autenticar.";
                    }
                }
            });
        }
        
        async function loadInitialData() {
            setupDateFilters();
            loadCategories(); // Carrega categorias primeiro
            loadAccounts();
            loadTransactions(); // Carrega transações (que dependem de categorias/contas para exibição)
            setupUIListeners();
            updateModalFormLogic();
        }
        
        function setupDateFilters() {
            const months = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            // Limpa todos os filtros
            [filterMonth, filterYear, txFilterMonth, txFilterYear, budgetFilterMonth, budgetFilterYear].forEach(sel => {
                sel.innerHTML = '';
            });

            months.forEach((month, index) => {
                const option = new Option(month, index);
                filterMonth.add(option.cloneNode(true));
                txFilterMonth.add(option.cloneNode(true));
                budgetFilterMonth.add(option.cloneNode(true));
            });

            for (let i = currentYear - 3; i <= currentYear + 3; i++) {
                const option = new Option(i, i);
                filterYear.add(option.cloneNode(true));
                txFilterYear.add(option.cloneNode(true));
                budgetFilterYear.add(option.cloneNode(true));
            }
            
            // Define os valores selecionados APÓS o loop
            filterMonth.value = currentMonth;
            filterYear.value = currentYear;
            txFilterMonth.value = currentMonth;
            txFilterYear.value = currentYear;
            budgetFilterMonth.value = currentMonth;
            budgetFilterYear.value = currentYear;
            
            // Listeners do Dashboard
            filterMonth.addEventListener('change', () => updateDashboard(allTransactions));
            filterYear.addEventListener('change', () => updateDashboard(allTransactions));
            
            // Listeners dos Lançamentos
            txFilterMonth.addEventListener('change', renderTransactionsTable);
            txFilterYear.addEventListener('change', renderTransactionsTable);
            
            // Listeners do Orçamento
            budgetFilterMonth.addEventListener('change', renderBudgetsPage);
            budgetFilterYear.addEventListener('change', renderBudgetsPage);
        }
        
        function setupUIListeners() {
            modalForm.addEventListener('submit', handleAddTransaction);
            formAddAccount.addEventListener('submit', handleAddConfig);
            formAddCategory.addEventListener('submit', handleAddConfig);
            
            tipoSelect.addEventListener('change', updateModalFormLogic);
            tipoDespesaSelect.addEventListener('change', updateModalFormLogic);
            parcelasInput.addEventListener('input', updateModalFormLogic);
        }

        // --- LÓGICA DO FORMULÁRIO ---
        function updateModalFormLogic() {
            const tipo = tipoSelect.value;
            const tipoDespesa = tipoDespesaSelect.value;
            const parcelas = parseInt(parcelasInput.value) || 1;

            if (tipo === 'receita') {
                tipoDespesaRow.style.display = 'none';
                tipoValorRow.style.display = 'none';
                parcelasLabel.textContent = "Repetir por (Meses)";
            } else {
                tipoDespesaRow.style.display = 'block';
                if (tipoDespesa === 'Fixa') {
                    parcelasLabel.textContent = "Lançar para os próximos (meses)";
                    tipoValorRow.style.display = 'none';
                } else {
                    parcelasLabel.textContent = "Nº de Parcelas (1 = à vista)";
                    if (parcelas > 1) {
                        tipoValorRow.style.display = 'block';
                    } else {
                        tipoValorRow.style.display = 'none';
                    }
                }
            }
        }


        // --- CARREGAMENTO DE DADOS (FIRESTORE ONSNAPSHOT) ---

        function loadCategories() {
            const categoriesCollection = collection(db, categoriesCollectionPath);
            onSnapshot(categoriesCollection, (snapshot) => {
                allCategories = [];
                categoriesList.innerHTML = '';
                selectCategoria.innerHTML = '';
                
                if (snapshot.empty) {
                    categoriesList.innerHTML = '<li class="py-2 text-slate-500 dark:text-slate-400">Nenhuma categoria cadastrada.</li>';
                }

                snapshot.docs.forEach(doc => {
                    const category = { id: doc.id, ...doc.data() };
                    allCategories.push(category);
                    
                    const li = document.createElement('li');
                    li.className = "py-2 flex justify-between items-center";
                    li.innerHTML = `
                        <span class="text-slate-700 dark:text-slate-300">${category.name}</span>
                        <button data-id="${category.id}" data-type="category" class="delete-config-btn text-red-500 hover:text-red-700 text-sm font-medium">Excluir</button>
                    `;
                    categoriesList.appendChild(li);
                    
                    selectCategoria.add(new Option(category.name, category.name));
                });
                
                document.querySelectorAll('.delete-config-btn[data-type="category"]').forEach(btn => {
                   btn.addEventListener('click', () => handleDeleteConfig(btn.dataset.id, categoriesCollectionPath));
                });
                
                // Após carregar categorias, renderiza a página de orçamentos
                renderBudgetsPage();
                // E atualiza o dashboard (que depende das categorias)
                updateDashboard(allTransactions);
            });
        }

        function loadAccounts() {
            const accountsCollection = collection(db, accountsCollectionPath);
            onSnapshot(accountsCollection, (snapshot) => {
                allAccounts = [];
                accountsList.innerHTML = '';
                selectConta.innerHTML = '';

                if (snapshot.empty) {
                    accountsList.innerHTML = '<li class="py-2 text-slate-500 dark:text-slate-400">Nenhuma conta cadastrada.</li>';
                }

                snapshot.docs.forEach(doc => {
                    const account = { id: doc.id, ...doc.data() };
                    allAccounts.push(account);
                    
                    const li = document.createElement('li');
                    li.className = "py-2 flex justify-between items-center";
                    li.innerHTML = `
                        <span class="text-slate-700 dark:text-slate-300">${account.name}</span>
                        <button data-id="${account.id}" data-type="account" class="delete-config-btn text-red-500 hover:text-red-700 text-sm font-medium">Excluir</button>
                    `;
                    accountsList.appendChild(li);
                    
                    selectConta.add(new Option(account.name, account.name));
                });
                
                document.querySelectorAll('.delete-config-btn[data-type="account"]').forEach(btn => {
                   btn.addEventListener('click', () => handleDeleteConfig(btn.dataset.id, accountsCollectionPath));
                });
            });
        }

        function loadTransactions() {
            const transCollection = collection(db, transactionsCollectionPath);
            onSnapshot(transCollection, (snapshot) => {
                allTransactions = [];
                snapshot.docs.forEach(doc => {
                    const tx = { id: doc.id, ...doc.data() };
                    allTransactions.push(tx);
                });
                
                allTransactions.sort((a, b) => new Date(b.dataVencimento) - new Date(a.dataVencimento));

                renderTransactionsTable(); 
                updateDashboard(allTransactions);
            });
        }

        // --- RENDERIZAÇÃO E LÓGICA DE UI ---

        function renderTransactionsTable() {
            transactionsTableBody.innerHTML = ''; 
            
            const selectedMonth = parseInt(txFilterMonth.value); 
            const selectedYear = parseInt(txFilterYear.value);

            const filteredTransactions = allTransactions.filter(tx => {
                const txDate = new Date(tx.dataVencimento + 'T00:00:00'); 
                return txDate.getMonth() === selectedMonth && txDate.getFullYear() === selectedYear;
            });

            if (filteredTransactions.length === 0) {
                transactionsTableBody.innerHTML = '<tr><td colspan="9" class="p-4 text-center text-slate-500 dark:text-slate-400">Nenhum lançamento para este mês.</td></tr>';
                return;
            }

            filteredTransactions.forEach(tx => {
                const tr = renderTransactionRow(tx);
                transactionsTableBody.appendChild(tr);
            });
        }

        function renderTransactionRow(tx) {
            const tr = document.createElement('tr');
            // CORREÇÃO v6.2: Alterado dark:bg-gray-900 para dark:bg-gray-800
            tr.className = tx.tipo === 'receita' ? 'bg-green-50 dark:bg-green-900/20' : 'bg-white dark:bg-gray-800';
            
            const isPendente = !tx.dataPagamento;
            const isPaid = !isPendente;
            
            const statusClass = isPendente ? 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-200' : 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200';
            const statusText = isPendente ? 'Pendente' : 'Pago';
            
            const valorClass = tx.tipo === 'receita' ? 'text-green-600' : 'text-red-600';
            const valor = (tx.tipo === 'receita' ? 1 : -1) * tx.valor;
            
            const dataVenc = new Date(tx.dataVencimento + 'T00:00:00').toLocaleDateString('pt-BR');
            const dataPagto = tx.dataPagamento ? new Date(tx.dataPagamento + 'T00:00:00').toLocaleDateString('pt-BR') : '---';
            
            const statusButtonIcon = isPendente ? 
                `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-600"><path d="M20 6 9 17l-5-5"></path></svg>` : 
                `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-orange-600"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`; 
            const statusButtonTitle = isPendente ? "Marcar como Pago" : "Marcar como Pendente";

            tr.innerHTML = `
                <td class="p-4 whitespace-nowrap text-sm font-medium text-slate-900 dark:text-slate-100">${tx.descricao} ${tx.parcela || ''}</td>
                <td class="p-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${dataVenc}</td>
                <td class="p-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${dataPagto}</td>
                <td class="p-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${tx.categoria}</td>
                <td class="p-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${tx.conta}</td>
                <td class="p-4 whitespace-nowrap text-sm text-slate-500 dark:text-slate-400">${tx.tipoDespesa || 'Variável'}</td>
                <td class="p-4 whitespace-nowrap text-sm text-center">
                    <span class="px-2.5 py-0.5 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClass}">${statusText}</span>
                </td>
                <td class="p-4 whitespace-nowrap text-sm text-right font-medium ${valorClass}">${formatCurrency(valor)}</td>
                <td class="p-4 whitespace-nowrap text-sm text-center">
                    <button onclick="handleToggleStatus('${tx.id}', ${isPaid})" title="${statusButtonTitle}" class="action-btn">
                        ${statusButtonIcon}
                    </button>
                    <button onclick="handleDeleteTransaction('${tx.id}')" title="Excluir Lançamento" class="action-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-600"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </td>
            `;
            return tr;
        }

        async function updateDashboard(transactions) {
            const selectedMonth = parseInt(filterMonth.value); 
            const selectedYear = parseInt(filterYear.value);

            const filteredTransactions = transactions.filter(tx => {
                const txDate = new Date(tx.dataVencimento + 'T00:00:00'); 
                return txDate.getMonth() === selectedMonth && txDate.getFullYear() === selectedYear;
            });

            let totalReceitas = 0;
            let totalDespesasPagas = 0;
            let totalPendentes = 0;
            const gastosPorCategoria = {};
            const contasPendentes = [];

            filteredTransactions.forEach(tx => {
                const isPendente = !tx.dataPagamento;

                if (tx.tipo === 'receita') {
                    if (!isPendente) { 
                        totalReceitas += tx.valor;
                    }
                } else { // Despesa
                    if (isPendente) {
                        totalPendentes += tx.valor;
                        contasPendentes.push(tx);
                    } else {
                        totalDespesasPagas += tx.valor;
                        
                        if (!gastosPorCategoria[tx.categoria]) {
                            gastosPorCategoria[tx.categoria] = 0;
                        }
                        gastosPorCategoria[tx.categoria] += tx.valor;
                    }
                }
            });

            const saldoMes = totalReceitas - totalDespesasPagas;

            document.getElementById('dash-receitas').textContent = formatCurrency(totalReceitas);
            document.getElementById('dash-despesas').textContent = formatCurrency(-totalDespesasPagas);
            document.getElementById('dash-saldo').textContent = formatCurrency(saldoMes);
            document.getElementById('dash-pendentes').textContent = formatCurrency(-totalPendentes);

            // --- LÓGICA DO GRÁFICO (Chart.js) ---
            const dashCategorias = document.getElementById('dash-categorias');
            const sortedCategorias = Object.entries(gastosPorCategoria).sort(([,a],[,b]) => b-a);
            
            // Destrói o gráfico antigo, se existir
            if (categoryChartInstance) {
                categoryChartInstance.destroy();
                categoryChartInstance = null;
            }
            dashCategorias.innerHTML = ''; // Limpa o conteúdo (texto ou canvas antigo)

            if (sortedCategorias.length === 0) {
                 dashCategorias.innerHTML = '<p class="text-slate-500 dark:text-slate-400 p-4 text-center h-full flex items-center justify-center">Nenhuma despesa paga este mês.</p>';
            } else {
                // Adiciona o canvas
                const canvas = document.createElement('canvas');
                dashCategorias.appendChild(canvas);
                const ctx = canvas.getContext('2d');

                const labels = sortedCategorias.map(([nome]) => nome);
                const dataValues = sortedCategorias.map(([,valor]) => valor);
                
                // Gerar cores dinâmicas a partir da paleta
                const colors = dataValues.map((_, i) => CHART_COLORS[i % CHART_COLORS.length]);
                
                // *** CORREÇÃO v6.3: Verifica o modo escuro no momento da renderização ***
                const isDarkMode = document.documentElement.classList.contains('dark');
                const legendColor = isDarkMode ? '#e2e8f0' : '#334155'; // Cor do texto da legenda
                const borderColor = isDarkMode ? '#1f2937' : '#ffffff'; // Cor de fundo do card

                categoryChartInstance = new Chart(ctx, {
                    type: 'doughnut', // Gráfico de rosca
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Gastos',
                            data: dataValues,
                            backgroundColor: colors,
                            borderColor: borderColor, // Borda combina com o fundo do card
                            borderWidth: 3
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom', // Legenda embaixo
                                labels: {
                                    color: legendColor, // Cor do texto corrigida
                                    padding: 15,
                                    font: {
                                        family: 'Inter',
                                        weight: '500'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.chart.getDatasetMeta(0).total;
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return ` ${label}: ${formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            // --- FIM DA LÓGICA DO GRÁFICO ---


            const dashFaturas = document.getElementById('dash-faturas');
            dashFaturas.innerHTML = '';
            if (contasPendentes.length === 0) {
                dashFaturas.innerHTML = '<li class="py-3 text-slate-500 dark:text-slate-400">Nenhuma conta pendente este mês.</li>';
            } else {
                contasPendentes.sort((a,b) => new Date(a.dataVencimento) - new Date(b.dataVencimento))
                    .forEach(tx => {
                        const dataVenc = new Date(tx.dataVencimento + 'T00:00:00').toLocaleDateString('pt-BR');
                        dashFaturas.innerHTML += `
                            <li class="py-3">
                                <div class="flex items-center space-x-4">
                                    <div class="flex-shrink-0">
                                        <span class="text-lg">💳</span>
                                    </div>
                                    <div class="flex-1 min-w-0">
                                        <p class="text-sm font-medium text-slate-900 dark:text-slate-100 truncate">${tx.descricao} ${tx.parcela || ''}</p>
                                        <p class="text-sm text-slate-500 dark:text-slate-400 truncate">Venc: ${dataVenc} (${tx.conta})</p>
                                    </div>
                                    <div class="text-base font-semibold text-red-600">${formatCurrency(-tx.valor)}</div>
                                </div>
                            </li>
                        `;
                    });
            }
            
            // --- LÓGICA DO NOVO CARD DE ORÇAMENTOS ---
            const budgetDocId = `${currentUserId}_${selectedYear}_${selectedMonth}`;
            const budgetDocRef = doc(db, budgetsCollectionPath, budgetDocId);
            const budgetDoc = await getDoc(budgetDocRef);
            const budgets = budgetDoc.exists() ? budgetDoc.data() : {};
            
            const dashBudgets = document.getElementById('dash-budgets');
            dashBudgets.innerHTML = '';
            
            const categoriesWithBudgets = allCategories.filter(cat => budgets[cat.name] && budgets[cat.name] > 0);
            
            if (categoriesWithBudgets.length === 0) {
                dashBudgets.innerHTML = '<p class="text-slate-500 dark:text-slate-400">Nenhum orçamento definido para este mês. Defina na página \'Orçamentos\'.</p>';
            } else {
                let totalGasto = 0;
                let totalOrcado = 0;
                
                categoriesWithBudgets.forEach(cat => {
                    const gasto = gastosPorCategoria[cat.name] || 0;
                    const orcado = budgets[cat.name] || 0;
                    const perc = (orcado > 0) ? (gasto / orcado) * 100 : 0;
                    const barColor = perc > 100 ? 'bg-red-500' : (perc > 80 ? 'bg-yellow-500' : 'bg-indigo-500');
                    
                    totalGasto += gasto;
                    totalOrcado += orcado;
                    
                    dashBudgets.innerHTML += `
                        <div>
                            <div class="flex justify-between mb-1">
                                <span class="text-sm font-medium text-slate-600 dark:text-slate-300">${cat.name}</span>
                                <span class="text-sm font-medium text-slate-600 dark:text-slate-300">${formatCurrency(gasto)} / ${formatCurrency(orcado)}</span>
                            </div>
                            <div class="w-full progress-bar-bg rounded-full h-2.5">
                                <div class="${barColor} h-2.5 rounded-full" style="width: ${Math.min(perc, 100)}%"></div>
                            </div>
                        </div>
                    `;
                });
                
                // Adiciona um resumo total
                 const totalPerc = (totalOrcado > 0) ? (totalGasto / totalOrcado) * 100 : 0;
                 const totalBarColor = totalPerc > 100 ? 'bg-red-500' : (totalPerc > 80 ? 'bg-yellow-500' : 'bg-indigo-500');
                 dashBudgets.innerHTML = `
                    <div class="border-b dark:border-gray-700 pb-4 mb-4">
                        <div class="flex justify-between mb-1">
                            <span class="text-sm font-bold text-slate-800 dark:text-slate-100">Total Orçado</span>
                            <span class="text-sm font-bold text-slate-800 dark:text-slate-100">${formatCurrency(totalGasto)} / ${formatCurrency(totalOrcado)}</span>
                        </div>
                        <div class="w-full progress-bar-bg rounded-full h-2.5">
                            <div class="${totalBarColor} h-2.5 rounded-full" style="width: ${Math.min(totalPerc, 100)}%"></div>
                        </div>
                    </div>
                 ` + dashBudgets.innerHTML;
            }
        }
        
        // --- NOVA LÓGICA DE ORÇAMENTOS (Página 'Orçamentos') ---
        async function renderBudgetsPage() {
            if (!allCategories || allCategories.length === 0) {
                budgetsListEl.innerHTML = '<p class="text-slate-500 dark:text-slate-400">Cadastre suas categorias primeiro na página de Configurações.</p>';
                return;
            }
            
            const selectedMonth = parseInt(budgetFilterMonth.value);
            const selectedYear = parseInt(budgetFilterYear.value);
            const budgetDocId = `${currentUserId}_${selectedYear}_${selectedMonth}`;
            const budgetDocRef = doc(db, budgetsCollectionPath, budgetDocId);
            
            budgetsListEl.innerHTML = '<p class="text-slate-500 dark:text-slate-400">Carregando orçamentos...</p>';
            
            const budgetDoc = await getDoc(budgetDocRef);
            const budgets = budgetDoc.exists() ? budgetDoc.data() : {};
            
            budgetsListEl.innerHTML = '';
            
            allCategories.forEach(cat => {
                const budgetValue = budgets[cat.name] || 0;
                
                const div = document.createElement('div');
                div.className = "flex items-center space-x-4";
                div.innerHTML = `
                    <label for="budget-${cat.id}" class="w-1/3 text-sm font-medium text-slate-700 dark:text-slate-300">${cat.name}</label>
                    <div class="flex-1 relative">
                        <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-500 dark:text-slate-400">R$</span>
                        <input 
                            type="number" 
                            id="budget-${cat.id}" 
                            data-category-name="${cat.name}"
                            value="${budgetValue}"
                            placeholder="0,00"
                            class="budget-input pl-10 pr-3 py-2 block w-full border border-slate-300 dark:border-gray-700 dark:bg-gray-800 dark:text-white dark:placeholder-gray-500 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 transition-colors duration-200"
                        >
                    </div>
                `;
                budgetsListEl.appendChild(div);
            });
            
            // Adiciona listeners para salvar "on-the-fly"
            document.querySelectorAll('.budget-input').forEach(input => {
                input.addEventListener('change', handleSaveBudget); // Salva ao perder o foco
            });
        }
        
        async function handleSaveBudget(e) {
            const input = e.target;
            const categoryName = input.dataset.categoryName;
            const value = parseFloat(input.value) || 0;
            
            const selectedMonth = parseInt(budgetFilterMonth.value);
            const selectedYear = parseInt(budgetFilterYear.value);
            const budgetDocId = `${currentUserId}_${selectedYear}_${selectedMonth}`;
            const budgetDocRef = doc(db, budgetsCollectionPath, budgetDocId);

            try {
                // setDoc com merge=true cria o documento se não existir ou atualiza o campo específico
                await setDoc(budgetDocRef, {
                    [categoryName]: value
                }, { merge: true });
                
                // Feedback visual rápido
                input.classList.add('border-green-500', 'dark:border-green-500');
                setTimeout(() => {
                    input.classList.remove('border-green-500', 'dark:border-green-500');
                }, 1500);

            } catch (error) {
                console.error("Erro ao salvar orçamento:", error);
                input.classList.add('border-red-500', 'dark:border-red-500');
            }
        }


        // --- MANIPULAÇÃO DE DADOS (CRUD) ---

        async function handleAddTransaction(e) {
            e.preventDefault();
            const formData = new FormData(modalForm);
            
            const desc = formData.get('desc');
            const tipo = formData.get('tipo'); 
            const tipoDespesa = (tipo === 'receita') ? null : formData.get('tipoDespesa');
            const valor = parseFloat(formData.get('valor'));
            const tipoValor = formData.get('tipoValor'); 
            const dataVenc = formData.get('venc');
            const dataPagto = formData.get('pagto') || null; 
            const categoria = formData.get('categoria');
            const conta = formData.get('conta');
            const parcelas = parseInt(formData.get('parcelas') || 1);

            if (!desc || !valor || !dataVenc || !categoria || !conta || (tipo === 'despesa' && !tipoDespesa)) {
                console.error("Formulário inválido", Object.fromEntries(formData));
                return;
            }

            loadingOverlay.style.display = 'flex';
            
            let valorParcela = valor;
            if (tipo === 'despesa' && tipoDespesa === 'Variavel' && parcelas > 1 && tipoValor === 'total') {
                 valorParcela = (valor / parcelas);
            }
            
            try {
                const transCollection = collection(db, transactionsCollectionPath);
                const dataVencBase = new Date(dataVenc + 'T00:00:00');
                
                for (let i = 1; i <= parcelas; i++) {
                    const dataVencParcela = new Date(dataVencBase);
                    dataVencParcela.setMonth(dataVencBase.getMonth() + (i - 1));
                    
                    const dataPagtoParcela = (i === 1) ? dataPagto : null;
                    const labelParcela = (parcelas > 1) ? `(${i}/${parcelas})` : null;
                    
                    await addDoc(transCollection, {
                        descricao: desc,
                        tipo: tipo,
                        tipoDespesa: tipoDespesa,
                        valor: valorParcela,
                        dataVencimento: dataVencParcela.toISOString().split('T')[0],
                        dataPagamento: dataPagtoParcela,
                        categoria: categoria,
                        conta: conta,
                        parcela: labelParcela,
                        criadoPor: currentUserId,
                        criadoEm: new Date().toISOString()
                    });
                }
                
                modalForm.reset();
                updateModalFormLogic(); 
                closeModal('add-modal');

            } catch (error) {
                console.error("Erro ao adicionar transação:", error);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        async function handleToggleStatus(id, isPaid) {
            loadingOverlay.style.display = 'flex';
            const docRef = doc(db, transactionsCollectionPath, id);
            
            try {
                if (isPaid) {
                    await updateDoc(docRef, { dataPagamento: null });
                } else {
                    const hoje = new Date().toISOString().split('T')[0];
                    await updateDoc(docRef, { dataPagamento: hoje });
                }
            } catch (error) {
                console.error("Erro ao atualizar status:", error);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        window.handleToggleStatus = handleToggleStatus;

        
        async function handleDeleteTransaction(id) {
            const confirmDelete = prompt("Tem certeza que quer excluir este lançamento? Digite 'sim' para confirmar.");
            
            if (confirmDelete === 'sim') {
                loadingOverlay.style.display = 'flex';
                try {
                    const docRef = doc(db, transactionsCollectionPath, id);
                    await deleteDoc(docRef);
                } catch (error) {
                    console.error("Erro ao excluir transação:", error);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
        }
        window.handleDeleteTransaction = handleDeleteTransaction;
        
        async function handleAddConfig(e) {
            e.preventDefault();
            const formId = e.target.id;
            let input, collectionPath;
            
            if (formId === 'form-add-account') {
                input = document.getElementById('input-account-name');
                collectionPath = accountsCollectionPath;
            } else {
                input = document.getElementById('input-category-name');
                collectionPath = categoriesCollectionPath;
            }
            
            const name = input.value.trim();
            if (!name) return;
            
            loadingOverlay.style.display = 'flex';
            try {
                const configCollection = collection(db, collectionPath);
                await addDoc(configCollection, {
                    name: name,
                    criadoPor: currentUserId
                });
                input.value = ''; 
            } catch (error) {
                console.error("Erro ao adicionar configuração:", error);
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        async function handleDeleteConfig(id, collectionPath) {
             const confirmDelete = prompt("Tem certeza que quer excluir este item? Digite 'sim' para confirmar.");
             if (confirmDelete === 'sim') {
                loadingOverlay.style.display = 'flex';
                try {
                    const docRef = doc(db, collectionPath, id);
                    await deleteDoc(docRef);
                } catch (error) {
                    console.error("Erro ao excluir configuração:", error);
                } finally {
                    loadingOverlay.style.display = 'none';
                }
            }
        }
        document.querySelectorAll('.delete-config-btn').forEach(btn => {
            btn.addEventListener('click', () => handleDeleteConfig(btn.dataset.id, btn.dataset.type === 'category' ? categoriesCollectionPath : accountsCollectionPath));
        });

        // --- UTILITÁRIOS ---
        
        function formatCurrency(value) {
            return value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
        }

        window.showPage = (pageId) => {
            document.querySelectorAll('.page-content').forEach(page => page.style.display = 'none');
            document.querySelectorAll('.sidebar-button').forEach(btn => btn.classList.remove('active'));
            
            const pageEl = document.getElementById(pageId);
            const btnEl = document.querySelector(`button[onclick="showPage('${pageId}')"]`);
            
            if (pageEl) pageEl.style.display = 'block';
            if (btnEl) btnEl.classList.add('active');
            
            // Recarrega os dados da página de orçamento se ela for aberta
            if (pageId === 'page-orcamento') {
                renderBudgetsPage();
            }
            // Força a atualização do dashboard (e do gráfico) se for a página do dashboard
            if (pageId === 'page-dashboard') {
                updateDashboard(allTransactions);
            }
        };

        window.openModal = (modalId) => {
            document.getElementById(modalId).style.display = 'flex';
        };

        window.closeModal = (modalId) => {
            document.getElementById(modalId).style.display = 'none';
        };

        document.addEventListener('DOMContentLoaded', initFirebase);
    </script>
</body>
</html>





